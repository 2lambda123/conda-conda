#!/bin/bash

# Ensure that this script is sourced, not executed
# Note that if the script was executed, we're running inside bash!
if [[ -n $BASH_VERSION ]] && [[ "${BASH_SOURCE[0]}" == "$0" ]]; then
    >&2 echo "Error: deactivate must be sourced. Run 'source deactivate'
instead of 'deactivate'.
"
    "$(dirname $0)/conda" ..sourcehelp --deactivate
    exit 1
fi

# Determine the directory containing this script
if [[ -n $BASH_VERSION ]]; then
    _SCRIPT_LOCATION=${BASH_SOURCE[0]}
elif [[ -n $ZSH_VERSION ]]; then
    _SCRIPT_LOCATION=${funcstack[1]}
else
    echo "Only bash and zsh are supported"
    return 1
fi
_THIS_DIR=$(dirname "$_SCRIPT_LOCATION")
_NUM_OF_ARGS="$#"

# TODO Find a better way to do this that works on both bash and zsh
case "$1" in
"-h")
    "$_THIS_DIR/conda" ..sourcehelp --deactivate
    return -1
    ;;
"--help")
    "$_THIS_DIR/conda" ..sourcehelp --deactivate
    return -1
    ;;
esac


if [[ $_NUM_OF_ARGS -gt 0 ]]; then
    >&2 echo "Error: too many arguments."
    return 1
fi

_NEW_PATH=$("$_THIS_DIR/conda" ..activateroot "$@")
if (( $? == 0 )); then
    export PATH=$_NEW_PATH
    unset CONDA_DEFAULT_ENV
    if (( $($_THIS_DIR/conda ..changeps1) )); then
        PS1=$CONDA_OLD_PS1
        unset CONDA_OLD_PS1
    fi
else
    return $?
fi

if [[ -n $BASH_VERSION ]]; then
    hash -r
elif [[ -n $ZSH_VERSION ]]; then
    rehash
else
    echo "Only bash and zsh are supported"
    return 1
fi
