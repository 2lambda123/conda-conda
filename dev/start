#!/usr/bin/env bash
# NOTE: This script should be sourced! The shebang is only here to help syntax highlighters.

set -o errtrace -o pipefail -o errexit

DEVENV="${1:-./devenv}"
PYTHON="${PYTHON:-3}"
CONDA="${CONDA:-$DEVENV/bin/conda}"

if ! [ -f "$DEVENV/conda-meta/history" ]; then
    if [ "$(uname)" = Darwin ]; then
        if [ ! -f "miniconda${PYTHON}.sh" ]; then
            curl https://repo.anaconda.com/miniconda/Miniconda${PYTHON}-latest-MacOSX-x86_64.sh -o "miniconda${PYTHON}.sh"
        fi
        bash "miniconda${PYTHON}.sh" -bfp "$DEVENV"
        "${CONDA}" install -yq -p "$DEVENV" python="$PYTHON" --file tests/requirements.txt -c defaults
    elif [ "$(uname)" = Linux ]; then
        if [ ! -f miniconda${PYTHON}.sh ]; then
            curl "https://repo.anaconda.com/miniconda/Miniconda${PYTHON}-latest-Linux-x86_64.sh" -o "miniconda${PYTHON}.sh"
        fi
        bash "miniconda${PYTHON}.sh" -bfp "$DEVENV"
        "${CONDA}" install -yq -p "$DEVENV" python="$PYTHON" --file tests/requirements.txt -c defaults
        "${CONDA}" install -yq -p "$DEVENV" patchelf  # for conda-build
    else
        if [ ! -f "miniconda${PYTHON}.exe" ]; then
            powershell.exe -Command "(new-object System.Net.WebClient).DownloadFile('https://repo.anaconda.com/miniconda/Miniconda$PYTHON-latest-Windows-x86_64.exe','miniconda${PYTHON}.exe')"
        fi
        cmd.exe /c "start /wait \"\" miniconda${PYTHON}.exe /InstallationType=JustMe /RegisterPython=0 /AddToPath=0 /S /D=%CD%\$(cygpath -w $DEVENV)"
        CONDA="$DEVENV/Scripts/conda"
        "$DEVENV/Scripts/conda" install -yq -p "$DEVENV" python="$PYTHON" --file tests/requirements.txt -c defaults -c conda-forge
    fi
fi


if ! [ -f "$DEVENV/.dev-start-ed" ]; then
  "${CONDA}" install -yq -p "$DEVENV" python="$PYTHON" --file tests/requirements.txt -c defaults
  touch "$DEVENV/.dev-start-ed"
fi


case "$(uname)" in
    Darwin|Linux)  eval "$($DEVENV/bin/python -m conda init --dev bash)" ;;
               *)  eval "$($DEVENV/python -m conda init --dev bash)" ;;
esac
